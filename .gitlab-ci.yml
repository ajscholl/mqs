image: docker:latest
services:
- docker:dind

stages:
- compile
- image

before_script:
  - env
  - pwd
  - ls -lah

test:
  image: rust:1.34.0-stretch
  stage: compile
  script:
     - export CARGO_HOME=`pwd`/usr/local/cargo
     - export RUSTUP_HOME=`pwd`/usr/local/rustup
     - export PATH=$CARGO_HOME/bin:$RUSTUP_HOME/bin:$PATH
     - mkdir -p $CARGO_HOME $RUSTUP_HOME
     - rustup default nightly-2019-12-16
     - which cargo
     - cargo test --locked
  cache:
    paths:
      - target
      - usr/local/cargo

compile:
  image: rust:1.34.0-stretch
  stage: compile
  script:
     - export CARGO_HOME=`pwd`/usr/local/cargo
     - export RUSTUP_HOME=`pwd`/usr/local/rustup
     - export PATH=$CARGO_HOME/bin:$RUSTUP_HOME/bin:$PATH
     - mkdir -p $CARGO_HOME $RUSTUP_HOME
     - rustup default nightly-2019-12-16
     - which cargo
     - cargo build --locked --release
     - mkdir -p bin
     - mv target/release/mqs bin
     - ls -lah bin
  artifacts:
    paths:
    - bin/mqs
    expire_in: 1 week
  cache:
    paths:
      - target
      - usr/local/cargo

.template:image:
  stage: image
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build --tag $IMAGE_NAME --file $DOCKERFILE .
    - docker push $IMAGE_NAME
  dependencies:
    - compile

mqs:image:
  extends: .template:image
  variables:
    IMAGE_NAME: $CI_REGISTRY_IMAGE/mqs:$CI_COMMIT_REF_NAME
    DOCKERFILE: Dockerfile.mqs
